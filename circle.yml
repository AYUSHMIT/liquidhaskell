machine:
  ghc:
    version: 7.10.2
  pre:
    - sudo add-apt-repository -y ppa:hvr/z3
    - sudo add-apt-repository -y ppa:hvr/ghc
    - sudo apt-get -y update
    - sudo apt-get -y install z3 ghc-7.10.3

checkout:
  post:
    - git submodule sync
    - git submodule update --init
    - pwd
    - (cd .. && git clone https://github.com/alanz/liquid-fixpoint.git)
    - (cd ../liquid-fixpoint && git checkout parser-az)
    - pwd

dependencies:
  override:
    - cabal update
    - cabal sandbox init
    #- cabal sandbox add-source ./liquid-fixpoint
    - cabal sandbox add-source ../liquid-fixpoint
    - cabal sandbox add-source ./liquiddesugar
    - cabal install --upgrade-dependencies --reorder-goals --constraint="template-haskell installed" --dependencies-only --enable-tests --with-compiler=/opt/ghc/7.10.3/bin/ghc
    # - cabal install hpc-coveralls
    # - cabal configure --enable-tests --enable-library-coverage -finclude -fdevel
    - cabal configure --enable-tests -finclude -fdevel --with-compiler=/opt/ghc/7.10.3/bin/ghc

test:
  pre:
    - mkdir -p $CIRCLE_TEST_REPORTS/tasty
  override:
    - cabal build
    - cabal copy && cabal register
    - mkdir -p $CIRCLE_TEST_REPORTS/tasty/
    # We get a "test: ./tasty/junit.xml: canonicalizePath: does not exist (No such file or directory)" fail if it does not exist
    - touch $CIRCLE_TEST_REPORTS/tasty/junit.xml
    - cabal exec -- sh -c "./dist/build/test/test -j2 --xml=$CIRCLE_TEST_REPORTS/tasty/junit.xml --liquid-opts='--cores 1'":
        timeout: 1800
    - cabal exec -- sh -c "./dist/build/liquidhaskell-parser/liquidhaskell-parser -j2 --xml=$CIRCLE_TEST_REPORTS/tasty/junit.xml --liquid-opts='--cores 1'":
        timeout: 1800
  post:
    - cabal haddock --haddock-options="--no-print-missing-docs"
    - cp -r dist/doc $CIRCLE_ARTIFACTS
    - cp -r tests/logs/cur $CIRCLE_TEST_REPORTS/tasty/log
    # - hpc-coveralls --exclude-dir=tests --repo-token=$COVERALLS_REPO_TOKEN
